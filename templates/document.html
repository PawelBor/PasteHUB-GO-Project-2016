<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Document</title>
		<link rel="stylesheet" type="text/css" media="all"  href="/css/style.css" >
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>
	</head>
	<body>
		<script>
			$(document).ready(function() {
			  // adapted from http://stackoverflow.com/questions/10406930/how-to-construct-a-websocket-uri-relative-to-the-page-uri
			  	var loc = window.location, new_uri;
				if (loc.protocol === "https:") {
				    new_uri = "wss:";
				} else {
				    new_uri = "ws:";
				}
				new_uri += "//" + loc.host;
				new_uri += loc.pathname + "/ws";

				// Websocket code adapted from github.com/gorilla/websocket/examples/chat
			  	var conn;
			  	var msg;
			  	var doc;
			  	var userInputTimer;

		  		doc = document.getElementById("document");
		  		console.log(doc);
			    // Checks if browser supports websockets
			    if (window["WebSocket"]) {
			    	var uri = window.location.pathname;
			        conn = new WebSocket(new_uri);
			        console.log(conn);
			        conn.onclose = function (evt) {
			            window.alert("Connection closed.");
			        };
			        conn.onmessage = function (evt) {
			        	console.log(evt);
			        	doc.value = evt.data;	 
			        }
			    } else {
			        window.alert("Your browser does not support WebSockets.");
			    }

			  $("#document").on('input', function(evt){
			  	  	clearTimeout(userInputTimer);
			      	userInputTimer = setTimeout(function() {
			        if (!conn) {
			          console.log("No ws connection");
			          return false;
			        }
			        if (!doc.value) {
			          console.log("Message is null");
			          return false;
			        }
			        conn.send(doc.value);
			        console.log("Sending msg over ws");
			        return false;
			      }, 500);
			  });
			});
		</script>

		<page size="A4">
		  <textarea id="document">{{.Text}}</textarea>
		</page>
	</body>
</html>