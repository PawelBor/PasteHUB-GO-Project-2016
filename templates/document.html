<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Document</title>
		<link rel="stylesheet" type="text/css" media="all"  href="/css/style.css" >
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>
	</head>
	<body>
		<script>
		</script>

		<div id="visibility_wrapper" >
			
		</div>
		<script type="text/javascript">
		
			//Get the password
			var passwordDB = {{.Password}};

			$(document).ready(function() {
				// Block the script until the correct password is entered
				checkPassword();
			});

				
				function checkPassword(){
					if(passwordDB === ""){
						document.getElementById("visibility_wrapper").innerHTML
						='<page size="A4"><textarea id="document">{{.Text}}</textarea></page>'
					}else{
						document.getElementById("visibility_wrapper").innerHTML
						= '<input type="text" id="password" placeholder="Password"><button id="password_btn" onClick="waitForCorrectPassword()" >Log In</button>';

						waitForCorrectPassword();
					}
					
				}

				function waitForCorrectPassword(){
					//TIMER WHILE LOOP EVERY X SECONDS AWAIT


					//console.log(document.getElementById("password").value);
					if (document.getElementById("password").value === passwordDB){
						document.getElementById("visibility_wrapper").innerHTML
					='<page size="A4"><textarea id="document">{{.Text}}</textarea></page>'

					// adapted from http://stackoverflow.com/questions/10406930/how-to-construct-a-websocket-uri-relative-to-the-page-uri
				  	var loc = window.location, new_uri;
					if (loc.protocol === "https:") {
					    new_uri = "wss:";
					} else {
					    new_uri = "ws:";
					}
					new_uri += "//" + loc.host;
					new_uri += loc.pathname + "/ws";

					// Websocket code adapted from github.com/gorilla/websocket/examples/chat
				  	var conn;
				  	var msg;
				  	var doc;
				  	var userInputTimer;
				  	var saveToDbTimer;

			  		doc = document.getElementById("document");
			  		console.log(doc);
				    // Checks if browser supports websockets
				    if (window["WebSocket"]) {
				    	var uri = window.location.pathname;
				    	// Upgrade connection for current uri to a websocket
				        conn = new WebSocket(new_uri);
				        console.log(conn);
				        conn.onclose = function (evt) {
				            window.alert("Connection closed.");
				        };
				        conn.onmessage = function (evt) {
				        	console.log(evt);
				        	doc.value = evt.data;	 
				        }
				    } else {
				        window.alert("Your browser does not support WebSockets.");
				    }

				  var uri = window.location.pathname;
				  // An event on change of document
				  $("#document").on('input', function(evt){
				  	  	clearTimeout(userInputTimer);
				  	  	clearTimeout(saveToDbTimer);
				  	  	// Send stuff across websocket *timer*
				      	userInputTimer = setTimeout(function() {
					        if (!conn) {
					          console.log("No ws connection");
					          return false;
					        }
					        if (!doc.value) {
					          console.log("Message is null");
					          return false;
					        }
					        conn.send(doc.value);
					        console.log("Sending msg over ws");
					        return false;
				      	}, 500);

				      	// Save text to database *timer*
				      	saveToDbTimer = setTimeout(function() {
				        	// Save text to database
				        	var text = doc.value;
				        	$.ajax({
						        type: "PUT",
						        url: uri,
						        async: true,
						        data: {
						          uri : uri,
						          text : text
						        },
						        success: function(response){
						          console.log("Saved to db");
						        },
						        error: function(response){
						          console.log("PUT failed");
						        }
						   	});
				      	}, 5000);			  
				   });
						}else{
							return;
						}
					}
		</script>
	</body>
</html>